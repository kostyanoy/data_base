//первый запрос 

SELECT Т.ИД, В.ЧЛВК_ИД
FROM Н_ТИПЫ_ВЕДОМОСТЕЙ Т
RIGHT JOIN Н_ВЕДОМОСТИ В ON Т.ИД = В.ТВ_ИД
WHERE Т.НАИМЕНОВАНИЕ > 'Экзаменационный лист' 
AND В.ИД > 1457443
AND В.ИД = 1250972;



//второй запрос

SELECT Н_ЛЮДИ.ОТЧЕСТВО, Н_ОБУЧЕНИЯ.ЧЛВК_ИД, Н_УЧЕНИКИ.НАЧАЛО
FROM Н_ЛЮДИ
LEFT JOIN Н_ОБУЧЕНИЯ ON Н_ЛЮДИ.ИД = Н_ОБУЧЕНИЯ.ЧЛВК_ИД
LEFT JOIN Н_УЧЕНИКИ ON Н_ОБУЧЕНИЯ.ЧЛВК_ИД = Н_УЧЕНИКИ.ЧЛВК_ИД
WHERE Н_ЛЮДИ.ИД = 142095
AND Н_ОБУЧЕНИЯ.НЗК < '001000';



//третий запрос

SELECT DISTINCT Л.ИД, Л.ФАМИЛИЯ, Л.ИМЯ, ИНН, ФО.НАИМЕНОВАНИЕ
FROM Н_ЛЮДИ Л
JOIN Н_ОБУЧЕНИЯ О ON О.ЧЛВК_ИД = Л.ИД
JOIN Н_УЧЕНИКИ У ON У.ЧЛВК_ИД = О.ЧЛВК_ИД
JOIN Н_ПЛАНЫ П ON П.ИД = У.ПЛАН_ИД
JOIN Н_ФОРМЫ_ОБУЧЕНИЯ ФО ON ФО.ИД = П.ФО_ИД
WHERE Л.ИНН IS NULL
AND ФО.НАИМЕНОВАНИЕ LIKE '%вечерняя%'
ORDER BY 2, 3;



//четвертый запрос

//вывести структуру университета
SELECT М.ИД, С.ИД, Б.ИД, М.ИМЯ_В_ИМИН_ПАДЕЖЕ, С.ИМЯ_В_ИМИН_ПАДЕЖЕ, Б.
FROM Н_ОТДЕЛЫ М
JOIN Н_ОТДЕЛЫ С ON М.ОТД_ИД = С.ИД
JOIN Н_ОТДЕЛЫ Б ON С.ОТД_ИД = Б.ИД
ORDER BY 1,2,3;

WITH ЛЮДИ AS (
	SELECT DISTINCT Л.ИД, ИМЯ, ФАМИЛИЯ, ДАТА_РОЖДЕНИЯ
	FROM Н_ЛЮДИ Л
	JOIN Н_ОБУЧЕНИЯ О ON О.ЧЛВК_ИД = Л.ИД
	JOIN Н_УЧЕНИКИ У ON У.ЧЛВК_ИД = О.ЧЛВК_ИД
	JOIN Н_ПЛАНЫ П ON П.ИД = У.ПЛАН_ИД
	JOIN Н_ОТДЕЛЫ ОТ ON ОТ.ИД = П.ОТД_ИД_ЗАКРЕПЛЕН_ЗА
	WHERE ОТ.ИМЯ_В_ИМИН_ПАДЕЖЕ = 'кафедра вычислительной техники'
)
SELECT ИМЯ, COUNT(*) AS КОЛИЧЕСТВО
FROM ЛЮДИ
GROUP BY ИМЯ
HAVING COUNT(*) > 50
ORDER BY 2;



//пятый запрос

WITH ВОЗРАСТ_ЛЮДЕЙ AS (
	SELECT DISTINCT Л.ИД, date_part('year', now()) - date_part('year', ДАТА_РОЖДЕНИЯ) AS ВОЗРАСТ, ДАТА_РОЖДЕНИЯ, ГРУППА 
	FROM Н_ЛЮДИ Л
	JOIN Н_ОБУЧЕНИЯ О ON О.ЧЛВК_ИД = Л.ИД
	JOIN Н_УЧЕНИКИ У ON У.ЧЛВК_ИД = О.ЧЛВК_ИД
)
SELECT ГРУППА, AVG(ВОЗРАСТ) AS СРЕДНИЙ_ВОЗРАСТ
FROM ВОЗРАСТ_ЛЮДЕЙ
GROUP BY ГРУППА
HAVING AVG(ВОЗРАСТ) = (
	SELECT MIN(ВОЗРАСТ)
	FROM ВОЗРАСТ_ЛЮДЕЙ
	WHERE ГРУППА = '1100'
);




//шестой запрос

SELECT ГРУППА, Л.ИД, ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО, П_ПРКОК_ИД, СОСТОЯНИЕ 
FROM Н_ЛЮДИ Л
JOIN Н_ОБУЧЕНИЯ О ON О.ЧЛВК_ИД = Л.ИД
JOIN Н_УЧЕНИКИ У ON У.ЧЛВК_ИД = О.ЧЛВК_ИД
JOIN Н_ПЛАНЫ П ON П.ИД = У.ПЛАН_ИД
JOIN Н_ФОРМЫ_ОБУЧЕНИЯ ФО ON ФО.ИД = П.ФО_ИД
JOIN Н_НАПРАВЛЕНИЯ_СПЕЦИАЛ НС ON НС.ИД = П.НАПС_ИД
WHERE EXISTS (
	SELECT * 
	FROM Н_НАПР_СПЕЦ Н
	WHERE Н.КОД_НАПРСПЕЦ = '230101'
	AND Н.ИД = НС.НС_ИД
)
AND КУРС = 1
AND НАЧАЛО::date = '2012-09-01'
AND ФО.НАИМЕНОВАНИЕ = 'Заочная'
ORDER BY 3, 4;



//седьмой запрос

WITH ЛЮДИ AS (
	SELECT DISTINCT Л.ИД, П.УЧЕБНЫЙ_ГОД
	FROM Н_ЛЮДИ Л
	JOIN Н_ОБУЧЕНИЯ О ON О.ЧЛВК_ИД = Л.ИД
	JOIN Н_УЧЕНИКИ У ON У.ЧЛВК_ИД = О.ЧЛВК_ИД
	JOIN Н_ПЛАНЫ П ON П.ИД = У.ПЛАН_ИД
	JOIN Н_ОТДЕЛЫ ОТ ON ОТ.ИД = П.ОТД_ИД
	WHERE ОТ.КОРОТКОЕ_ИМЯ = 'КТиУ'
), ОТЛИЧНИКИ AS (
	SELECT Л.ИД, Л.УЧЕБНЫЙ_ГОД
	FROM ЛЮДИ Л
	JOIN Н_ВЕДОМОСТИ В ON В.ЧЛВК_ИД = Л.ИД
	GROUP BY Л.ИД, Л.УЧЕБНЫЙ_ГОД
	HAVING COUNT(*) = SUM(CASE WHEN ОЦЕНКА = 'зачет' OR ОЦЕНКА = '5' OR ОЦЕНКА = 'осв' OR ОЦЕНКА = '99' THEN 1 ELSE 0 END)
	ORDER BY 1
)
SELECT УЧЕБНЫЙ_ГОД, COUNT(*) AS ОТЛИЧНИКОВ 
FROM ОТЛИЧНИКИ
GROUP BY УЧЕБНЫЙ_ГОД
ORDER BY 1;
