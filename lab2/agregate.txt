человек
предметы
оценка
сумма оценок
средняя оценка
максимальная оценка
минимальнеая оценка

// без оконной функции

WITH ЛЮДИ AS (
	SELECT DISTINCT Л.ИД AS ЧЛВК_ИД, ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО
	FROM Н_ЛЮДИ Л
	JOIN Н_ОБУЧЕНИЯ О ON О.ЧЛВК_ИД = Л.ИД
	JOIN Н_УЧЕНИКИ У ON У.ЧЛВК_ИД = О.ЧЛВК_ИД
	JOIN Н_ПЛАНЫ П ON П.ИД = У.ПЛАН_ИД
	JOIN Н_ОТДЕЛЫ ОТ ON ОТ.ИД = П.ОТД_ИД
	JOIN Н_ВЕДОМОСТИ В ON В.ЧЛВК_ИД = Л.ИД
	WHERE ОТ.КОРОТКОЕ_ИМЯ = 'КТиУ'
), ПРЕДМЕТЫ AS (
	SELECT DISTINCT ЧЛВК_ИД, НАИМЕНОВАНИЕ, ДАТА, CAST(ОЦЕНКА AS INTEGER)
	FROM Н_ДИСЦИПЛИНЫ Д
	JOIN Н_СТРОКИ_ПЛАНОВ СП ON СП.ДИС_ИД = Д.ИД
	JOIN Н_ЭЛЕМЕНТЫ_СТРОК ЭС ON ЭС.СПЛ_ИД = СП.ИД
	JOIN Н_СОДЕРЖАНИЯ_ЭЛЕМЕНТОВ_СТРОК СЭС ON СЭС.ЭСТ_ИД = ЭС.ИД
	JOIN Н_ВЕДОМОСТИ В ON В.СЭС_ИД = СЭС.ИД
	WHERE ОЦЕНКА IN ('2', '3', '4', '5')
), ОЦЕНКИ AS (
	SELECT Л.ЧЛВК_ИД, НАИМЕНОВАНИЕ, 
	COUNT(ОЦЕНКА) AS КОЛИЧЕСТВО, 
	SUM(ОЦЕНКА) AS СУММА, 
	MIN(ОЦЕНКА) AS МИНИМУМ, 
	MAX(ОЦЕНКА) AS МАКСИМУМ, 
	round(AVG(ОЦЕНКА), 2) AS СРЕДНЯЯ
	FROM ЛЮДИ Л
	JOIN ПРЕДМЕТЫ П ON Л.ЧЛВК_ИД = П.ЧЛВК_ИД 
	GROUP BY Л.ЧЛВК_ИД, НАИМЕНОВАНИЕ
)
SELECT ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО, НАИМЕНОВАНИЕ, КОЛИЧЕСТВО, СУММА, МИНИМУМ, МИНИМУМ, СРЕДНЯЯ
FROM ОЦЕНКИ О
JOIN ЛЮДИ Л USING(ЧЛВК_ИД)
ORDER BY ЧЛВК_ИД, НАИМЕНОВАНИЕ;


// ОКОННЫЕ ФУНКЦИИ

WITH ОЦЕНКИ AS (
	SELECT DISTINCT Л.ИД, ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО, НАИМЕНОВАНИЕ, CAST(ОЦЕНКА AS INTEGER), ДАТА
	FROM Н_ЛЮДИ Л
	JOIN Н_ОБУЧЕНИЯ О ON О.ЧЛВК_ИД = Л.ИД
	JOIN Н_УЧЕНИКИ У ON У.ЧЛВК_ИД = О.ЧЛВК_ИД
	JOIN Н_ПЛАНЫ П ON П.ИД = У.ПЛАН_ИД
	JOIN Н_ОТДЕЛЫ ОТ ON ОТ.ИД = П.ОТД_ИД
	JOIN Н_ВЕДОМОСТИ В ON В.ЧЛВК_ИД = Л.ИД
	JOIN Н_СОДЕРЖАНИЯ_ЭЛЕМЕНТОВ_СТРОК СЭС ON В.СЭС_ИД = СЭС.ИД
	JOIN Н_ЭЛЕМЕНТЫ_СТРОК ЭС ON СЭС.ЭСТ_ИД = ЭС.ИД
	JOIN Н_СТРОКИ_ПЛАНОВ СП ON ЭС.СПЛ_ИД = СП.ИД
	JOIN Н_ДИСЦИПЛИНЫ Д ON СП.ДИС_ИД = Д.ИД
	WHERE ОЦЕНКА IN ('2', '3', '4', '5')
)
SELECT ИД, ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО, НАИМЕНОВАНИЕ, 
COUNT(ОЦЕНКА) OVER w AS КОЛИЧЕСТВО,
SUM(ОЦЕНКА) OVER w AS СУММА,
MIN(ОЦЕНКА) OVER w AS МИНИМУМ,
MAX(ОЦЕНКА) OVER w AS МАКСИМУМ,
AVG(ОЦЕНКА) OVER w AS СРЕДНЯЯ
FROM ОЦЕНКИ
WINDOW w AS (PARTITION BY ИД, НАИМЕНОВАНИЕ);

